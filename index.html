<!DOCTYPE html>
<html>
<head>
    <title>Legacy Map Pro - Recursive Edition</title>
    <style>
        body, html, #app { margin: 0; width: 100%; height: 100%; background: #0f172a; color: white; font-family: 'Inter', sans-serif; overflow: hidden; }
        #ui-layer { position: absolute; top: 20px; left: 20px; z-index: 10; background: rgba(30, 41, 59, 0.95); padding: 20px; border-radius: 12px; border: 1px solid #334155; backdrop-filter: blur(8px); width: 320px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        input { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #475569; background: #1e293b; color: white; margin-bottom: 10px; box-sizing: border-box; }
        button { background: #3b82f6; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; width: 100%; font-weight: bold; margin-bottom: 10px; transition: 0.2s; }
        button:hover { background: #2563eb; opacity: 0.9; }
        .secondary-btn { background: #475569; }
        .stats { font-size: 12px; color: #94a3b8; border-top: 1px solid #334155; padding-top: 10px; margin-top: 10px; line-height: 1.6; }
        .badge { background: #1e293b; padding: 2px 6px; border-radius: 4px; font-family: monospace; }
    </style>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/reactflow@11.10.1/dist/react-flow.standalone.am.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/reactflow@11.10.1/dist/style.css">
</head>
<body>
    <div id="app"></div>

    <script type="text/babel">
        const { useState, useCallback } = React;
        const ReactFlow = window.ReactFlow.default;
        const { Background, Controls, MarkerType } = window.ReactFlow;

        function App() {
            const [nodes, setNodes] = useState([]);
            const [edges, setEdges] = useState([]);
            const [githubUrl, setGithubUrl] = useState('');
            const [status, setStatus] = useState('Pronto para escanear');

            // Fun√ß√£o para gerar uma cor baseada no caminho da pasta (para agrupar visualmente)
            const getFolderColor = (path) => {
                const folder = path.split('/')[0] || 'root';
                let hash = 0;
                for (let i = 0; i < folder.length; i++) {
                    hash = folder.charCodeAt(i) + ((hash << 5) - hash);
                }
                return `hsl(${Math.abs(hash % 360)}, 60%, 45%)`;
            };

            const buildGraph = (files, relations) => {
                const newNodes = files.map((f) => ({
                    id: f.id,
                    data: { label: f.label },
                    position: { x: Math.random() * 1000, y: Math.random() * 800 },
                    style: { 
                        background: getFolderColor(f.id), 
                        color: 'white', 
                        fontSize: '10px',
                        width: 120,
                        textAlign: 'center',
                        borderRadius: '6px',
                        border: '1px solid rgba(255,255,255,0.2)'
                    }
                }));

                const newEdges = relations.map((rel, i) => {
                    // Tenta encontrar o alvo exato ou um arquivo que termine com o nome importado
                    const targetNode = files.find(f => f.id === rel.target || f.id.endsWith(rel.target + '.js') || f.id.endsWith(rel.target + '.ts'));
                    
                    return {
                        id: `e-${i}`,
                        source: rel.source,
                        target: targetNode ? targetNode.id : rel.target,
                        animated: true,
                        markerEnd: { type: MarkerType.ArrowClosed, color: '#94a3b8' },
                        style: { stroke: '#475569' }
                    };
                }).filter(e => files.some(f => f.id === e.target)); // Remove links para arquivos n√£o mapeados

                setNodes(newNodes);
                setEdges(newEdges);
            };

            const analyzeGithub = async () => {
                try {
                    setStatus('Buscando estrutura do repo...');
                    const match = githubUrl.match(/github\.com\/([^/]+)\/([^/]+)/);
                    if (!match) return alert("Cole uma URL v√°lida do GitHub");

                    const [_, owner, repo] = match;
                    // 1. Pega o SHA da branch principal (default)
                    const repoInfo = await fetch(`https://api.github.com/repos/${owner}/${repo}`).then(r => r.json());
                    const branch = repoInfo.default_branch;

                    // 2. Busca √°rvore recursiva
                    const treeRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/git/trees/${branch}?recursive=1`).then(r => r.json());
                    
                    const sourceFiles = treeRes.tree.filter(item => 
                        (item.path.endsWith('.js') || item.path.endsWith('.ts')) && !item.path.includes('node_modules')
                    );

                    setStatus(`Lendo ${sourceFiles.length} arquivos (isso pode demorar)...`);
                    
                    const files = [];
                    const relations = [];

                    // 3. Processa arquivos (limitado para n√£o estourar a API rapidamente)
                    for (const item of sourceFiles.slice(0, 50)) { // Limitamos a 50 arquivos no MVP para seguran√ßa
                        const fileRes = await fetch(`https://raw.githubusercontent.com/${owner}/${repo}/${branch}/${item.path}`);
                        const text = await fileRes.text();
                        
                        files.push({ id: item.path, label: item.path.split('/').pop() });

                        const importRegex = /from\s+['"]([^'"]+)['"]/g;
                        let m;
                        while ((m = importRegex.exec(text)) !== null) {
                            relations.push({ source: item.path, target: m[1].replace(/^\.\//, '') });
                        }
                    }

                    buildGraph(files, relations);
                    setStatus('An√°lise completa!');
                } catch (err) {
                    console.error(err);
                    setStatus('Erro ao acessar API do GitHub.');
                }
            };

            const analyzeFolder = async () => {
                const dirHandle = await window.showDirectoryPicker();
                setStatus('Escaneando pastas locais...');
                const files = [];
                const relations = [];

                async function scan(handle, path = "") {
                    for await (const entry of handle.values()) {
                        const fullPath = path ? `${path}/${entry.name}` : entry.name;
                        if (entry.kind === 'directory' && entry.name !== 'node_modules') {
                            await scan(entry, fullPath);
                        } else if (entry.name.endsWith('.js') || entry.name.endsWith('.ts')) {
                            const file = await entry.getFile();
                            const content = await file.text();
                            files.push({ id: fullPath, label: entry.name });
                            const importRegex = /from\s+['"]([^'"]+)['"]/g;
                            let m;
                            while ((m = importRegex.exec(content)) !== null) {
                                relations.push({ source: fullPath, target: m[1].replace(/^\.\//, '') });
                            }
                        }
                    }
                }
                await scan(dirHandle);
                buildGraph(files, relations);
                setStatus('Mapa local gerado!');
            };

            return (
                <div style={{ width: '100vw', height: '100vh' }}>
                    <div id="ui-layer">
                        <h2 style={{marginTop: 0, fontSize: '20px'}}>üó∫Ô∏è Legacy Map Pro</h2>
                        
                        <label style={{fontSize: '11px', color: '#94a3b8', fontWeight: 'bold'}}>GITHUB REPO (RECURSIVO)</label>
                        <input 
                            placeholder="https://github.com/usuario/projeto" 
                            value={githubUrl}
                            onChange={(e) => setGithubUrl(e.target.value)}
                        />
                        <button onClick={analyzeGithub}>Mapear Reposit√≥rio</button>
                        
                        <div style={{textAlign: 'center', margin: '5px 0', fontSize: '11px', color: '#475569'}}>OU</div>
                        
                        <button className="secondary-btn" onClick={analyzeFolder}>Abrir Pasta Local</button>
                        
                        <div className="stats">
                            <div><strong>Status:</strong> <span style={{color: '#fbbf24'}}>{status}</span></div>
                            <div><strong>Arquivos mapeados:</strong> <span className="badge">{nodes.length}</span></div>
                            <div style={{marginTop: '5px', fontSize: '10px'}}>Dica: Use o scroll para zoom e arraste os arquivos.</div>
                        </div>
                    </div>
                    
                    <ReactFlow nodes={nodes} edges={edges} fitView>
                        <Background color="#1e293b" gap={20} />
                        <Controls />
                    </ReactFlow>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('app'));
        root.render(<App />);
    </script>
</body>
</html>
