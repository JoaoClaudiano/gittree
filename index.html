<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Legacy Map Pro</title>
    <style>
        body, html, #app { margin: 0; width: 100%; height: 100%; background: #0f172a; color: white; font-family: sans-serif; overflow: hidden; }
        #ui-layer { position: absolute; top: 20px; left: 20px; z-index: 10; background: rgba(30, 41, 59, 0.95); padding: 20px; border-radius: 12px; border: 1px solid #334155; backdrop-filter: blur(8px); width: 310px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        input { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #475569; background: #1e293b; color: white; margin-bottom: 10px; box-sizing: border-box; }
        button { background: #3b82f6; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; width: 100%; font-weight: bold; transition: 0.3s; }
        button:hover { background: #2563eb; }
        .loading { display: flex; height: 100vh; justify-content: center; align-items: center; font-family: monospace; color: #3b82f6; }
    </style>
    
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/reactflow@11.10.1/dist/react-flow.standalone.am.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reactflow@11.10.1/dist/style.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.23.5/babel.min.js"></script>
</head>
<body>
    <div id="app"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Tenta encontrar o ReactFlow em diferentes locais do objeto window
        function getReactFlow() {
            return window.ReactFlow || window.default?.ReactFlow;
        }

        function App() {
            const [ready, setReady] = useState(false);
            const [nodes, setNodes] = useState([]);
            const [edges, setEdges] = useState([]);
            const [url, setUrl] = useState('');
            const [status, setStatus] = useState('');

            useEffect(() => {
                const check = setInterval(() => {
                    const rf = getReactFlow();
                    if (rf) {
                        console.log("ReactFlow detectado!", rf);
                        setReady(true);
                        clearInterval(check);
                    }
                }, 200);
                return () => clearInterval(check);
            }, []);

            if (!ready) return <div className="loading">Conectando bibliotecas (ReactFlow)...</div>;

            const RF = getReactFlow();
            const ReactFlowComponent = RF.default || RF;
            const { Background, Controls } = RF;

            const analyzeGithub = async () => {
                setStatus('Buscando...');
                try {
                    const match = url.match(/github\.com\/([^/]+)\/([^/]+)/);
                    if (!match) return alert("URL inv√°lida");
                    const [_, owner, repo] = match;
                    
                    const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/git/trees/main?recursive=1`).then(r => r.json());
                    if (!res.tree) throw new Error("Reposit√≥rio n√£o encontrado");

                    const files = res.tree
                        .filter(f => (f.path.endsWith('.js') || f.path.endsWith('.ts')) && !f.path.includes('node_modules'))
                        .slice(0, 20);
                    
                    setNodes(files.map((f, i) => ({
                        id: f.path,
                        data: { label: f.path.split('/').pop() },
                        position: { x: Math.random() * 400, y: Math.random() * 400 },
                        style: { background: '#3b82f6', color: '#fff', padding: '10px', borderRadius: '8px', fontSize: '10px' }
                    })));
                    
                    setStatus('Sucesso!');
                } catch (err) {
                    setStatus('Erro ao carregar');
                }
            };

            return (
                <div style={{ width: '100vw', height: '100vh' }}>
                    <div id="ui-layer">
                        <h2 style={{margin: '0 0 10px 0', fontSize: '18px'}}>üó∫Ô∏è Legacy Map Pro</h2>
                        <input 
                            placeholder="https://github.com/usuario/repo" 
                            value={url} 
                            onChange={e => setUrl(e.target.value)} 
                        />
                        <button onClick={analyzeGithub}>Mapear Projeto</button>
                        <p style={{fontSize: '11px', color: '#94a3b8'}}>{status || 'Aguardando URL...'}</p>
                    </div>

                    <ReactFlowComponent 
                        nodes={nodes} 
                        edges={edges} 
                        fitView
                        style={{background: '#0f172a'}}
                    >
                        <Background color="#1e293b" gap={20} />
                        <Controls />
                    </ReactFlowComponent>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('app'));
        root.render(<App />);
    </script>
</body>
</html>
