<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Legacy Map Pro</title>
    <link rel="stylesheet" href="style.css">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reactflow@11.10.1/dist/style.css">

    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "reactflow": "https://esm.sh/reactflow@11.10.1?external=react,react-dom"
        }
    }
    </script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <header class="main-header">
        <div class="logo">üó∫Ô∏è LEGACY<span style="color: #3b82f6;">MAP</span></div>
        <div class="version-tag">v2.0 (ESM)</div>
    </header>

    <div id="app"></div>

    <footer class="main-footer">
        Dica: Azul = JavaScript | Escuro = TypeScript | Ciano = React
    </footer>

    <script type="text/babel" data-type="module">
        // Agora importamos diretamente. Se a URL funcionar, a vari√°vel EXISTE.
        import React, { useState, useCallback } from 'react';
        import { createRoot } from 'react-dom/client';
        import ReactFlow, { Background, Controls } from 'reactflow';

        function App() {
            const [url, setUrl] = useState('');
            const [nodes, setNodes] = useState([]);
            const [edges, setEdges] = useState([]);
            const [status, setStatus] = useState('Pronto para mapear');
            const [repoBase, setRepoBase] = useState('');

            // Cores por extens√£o
            const getFileColor = (path) => {
                if (path.endsWith('.ts')) return '#1e40af';
                if (path.endsWith('.tsx')) return '#1d4ed8';
                if (path.endsWith('.jsx')) return '#06b6d4';
                if (path.endsWith('.css')) return '#ea580c';
                return '#3b82f6';
            };

            const onNodeClick = useCallback((event, node) => {
                if (repoBase && node.id) {
                    window.open(`${repoBase}/blob/main/${node.id}`, '_blank');
                }
            }, [repoBase]);

            const analyzeGithub = async () => {
                setStatus('üîç Conectando ao GitHub...');
                try {
                    const match = url.match(/github\.com\/([^/]+)\/([^/]+)/);
                    if (!match) return alert("URL inv√°lida. Ex: https://github.com/facebook/react");
                    const [_, owner, repo] = match;
                    
                    setRepoBase(`https://github.com/${owner}/${repo}`);

                    // 1. Busca a √°rvore de arquivos
                    const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/git/trees/main?recursive=1`).then(r => r.json());
                    
                    if (!res.tree) throw new Error("Branch 'main' n√£o encontrada ou repo privado.");

                    // 2. Filtra arquivos relevantes
                    const files = res.tree
                        .filter(f => (f.path.match(/\.(js|ts|jsx|tsx|css)$/)) && !f.path.includes('node_modules'))
                        .slice(0, 40); // Limite aumentado
                    
                    if (files.length === 0) {
                        setStatus('‚ö†Ô∏è Nenhum arquivo .js/.ts encontrado na raiz.');
                        return;
                    }

                    // 3. Cria os N√≥s (Nodes)
                    const newNodes = files.map((f, i) => ({
                        id: f.path,
                        data: { label: f.path.split('/').pop() },
                        position: { x: (i % 6) * 180, y: Math.floor(i / 6) * 120 },
                        style: { 
                            background: getFileColor(f.path), 
                            color: '#fff', 
                            borderRadius: '6px', 
                            padding: '10px', 
                            width: 150, 
                            fontSize: '11px',
                            textAlign: 'center',
                            cursor: 'pointer',
                            border: '1px solid rgba(255,255,255,0.2)',
                            boxShadow: '0 4px 6px rgba(0,0,0,0.3)'
                        }
                    }));

                    setNodes(newNodes);
                    setStatus(`‚úÖ Mapa gerado com ${newNodes.length} arquivos.`);
                } catch (err) {
                    console.error(err);
                    setStatus('‚ùå Erro: Verifique se o reposit√≥rio √© p√∫blico.');
                }
            };

            return (
                <div style={{ width: '100vw', height: 'calc(100vh - 95px)' }}>
                    <div id="ui-layer">
                        <div className="input-group">
                            <input 
                                placeholder="Cole o link do GitHub aqui..." 
                                value={url} 
                                onChange={e => setUrl(e.target.value)} 
                            />
                            <button onClick={analyzeGithub}>GERAR MAPA VISUAL</button>
                        </div>
                        <div className="status-box">{status}</div>
                    </div>

                    <ReactFlow 
                        nodes={nodes} 
                        edges={edges} 
                        onNodeClick={onNodeClick} 
                        fitView
                    >
                        <Background color="#1e293b" gap={25} />
                        <Controls />
                    </ReactFlow>
                </div>
            );
        }

        const root = createRoot(document.getElementById('app'));
        root.render(<App />);
    </script>
</body>
</html>
